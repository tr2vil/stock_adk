# =============================================
# Upstream Definitions
# =============================================
upstream orchestrator {
    server orchestrator:8000;
}

upstream news_agent {
    server news-agent:8001;
}

upstream fundamental_agent {
    server fundamental-agent:8002;
}

upstream technical_agent {
    server technical-agent:8003;
}

upstream expert_agent {
    server expert-agent:8004;
}

upstream risk_agent {
    server risk-agent:8005;
}

server {
    listen 80;
    server_name localhost;

    # =============================================
    # Orchestrator API
    # =============================================
    location /api/ {
        proxy_pass http://orchestrator;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # ADK API (Orchestrator의 A2A 엔드포인트)
    location /adk/ {
        proxy_pass http://orchestrator;
        proxy_set_header Host $host;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 300s;
    }

    # =============================================
    # Sub-Agents A2A Endpoints
    # =============================================

    # News Agent
    location /agents/news/ {
        proxy_pass http://news_agent/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 300s;
    }

    # Fundamental Agent (이전 balance_sheet)
    location /agents/fundamental/ {
        proxy_pass http://fundamental_agent/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 300s;
    }

    # Technical Agent
    location /agents/technical/ {
        proxy_pass http://technical_agent/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 300s;
    }

    # Expert Agent
    location /agents/expert/ {
        proxy_pass http://expert_agent/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 300s;
    }

    # Risk Agent
    location /agents/risk/ {
        proxy_pass http://risk_agent/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 300s;
    }

    # =============================================
    # Agent Discovery
    # =============================================
    location = /agents {
        default_type application/json;
        return 200 '{
            "orchestrator": {
                "name": "trading_orchestrator",
                "url": "/api/",
                "adk_url": "/adk/"
            },
            "agents": [
                {"name": "news_agent", "url": "/agents/news/", "port": 8001, "description": "종목 뉴스 수집 및 시황/센티먼트 분석"},
                {"name": "fundamental_agent", "url": "/agents/fundamental/", "port": 8002, "description": "재무제표 분석 및 밸류에이션 평가"},
                {"name": "technical_agent", "url": "/agents/technical/", "port": 8003, "description": "차트 기술적 분석 및 패턴 인식"},
                {"name": "expert_agent", "url": "/agents/expert/", "port": 8004, "description": "애널리스트 리포트 및 기관/외국인 수급 분석"},
                {"name": "risk_agent", "url": "/agents/risk/", "port": 8005, "description": "포지션 사이징 및 리스크 관리"}
            ]
        }';
    }

    # =============================================
    # Frontend (Optional - default route)
    # =============================================
    location / {
        proxy_pass http://frontend:5173;
        proxy_set_header Host $host;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
